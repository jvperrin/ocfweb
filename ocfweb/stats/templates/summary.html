{% extends 'base.html' %}
{% load common %}
{% load mathfilters %}
{% load stats %}
{% load ui_components %}

{% block content %}
    <script src="https://code.highcharts.com/highcharts.js" type="text/javascript"></script>

    <script type="text/javascript">
      document.addEventListener('DOMContentLoaded', function() {
        Highcharts.setOptions({
          global: {
            useUTC: true
          }
        });

        options = {
          chart: {
            plotBorderWidth: 2,
            renderTo: 'stats-chart',
            type: 'spline',
            zoomType: 'x'
          },
          credits: {
            enabled: false
          },
          title: {
            text: "Lab Utilization for {{ date }}"
          },
          tooltip: {
            dateTimeLabelFormats: {
              minute: "%l:%M %P",
              hour: "%l:%M %P"
            }
          },
          xAxis: {
            gridLineWidth: 1,
            tickInterval: 3600000, // Every hour
            title: {
              text: "Time"
            },
            type: "datetime",
            labels: {
              format: '{value: %l %P}',
            },
            // Allow a minimum zoom of 10 points shown
            minRange: 600000,
            min: {{ chart_start }},
            max: {{ chart_end }}
          },
          yAxis: {
            startOnTick: false,
            endOnTick: false,
            min: -0.1,
            // We currently have a maximum of 27 computers to show,
            // so 27.3 ensures the maximum is visible on the graph
            max: 27.3,
            title: {
              text: "Computers in Use"
            }
          },
          plotOptions: {
            spline: {
              color: '#000000',
              showInLegend: false,
              states: {
                hover: {
                  lineWidthPlus: 0
                }
              }
            }
          },
          series: [{
            name: "Users",
            animation: false,
            data: {{ graph_data }}
          }]
        };
        chart = new Highcharts.Chart(options);

        numPoints = chart.series[0].points.length
        lastPoint = chart.series[0].points[numPoints - 1].x
        chart.xAxis[0].addPlotLine({
          color: '#FF0000',
          width: 2,
          value: lastPoint
        });
      });
    </script>

    <div class="ocf-content-block">
        {% stats_navbar %}
        <div class="highcharts-wrapper">
            <div id="stats-chart"></div>
        </div>

        <img class="img-responsive" src="{% url 'sessions_image' %}" />

        <h3>Currently in Lab</h3>
        <p>
            There are {{users_in_lab_count}} users in the lab currently
            (including {{staff_in_lab|length}} staff).
        </p>
        {% if staff_in_lab %}
            <ul>
                {% for staff in staff_in_lab %}
                    <li>{{staff.user}} on {{staff.host}} for {{staff.duration}}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <h3>Printers</h3>
        <div class="row">
            {% for printer, toner, maintkit in printers %}
                <div class="col-sm-6">
                    <h4>{{printer}}</h4>
                    {% if toner %}
                        <p><strong>Toner: </strong> {{toner|getitem:0}} pages remaining</p>
                        {% progress_bar label='' value=toner|getitem:0 max=toner|getitem:1 %}
                    {% else %}
                        <p><strong>Toner: </strong> <em>unable to read</em></p>
                    {% endif %}
                    {% if maintkit %}
                        <p><strong>Maintenance Kit: </strong> {{maintkit|getitem:0}} pages remaining</p>
                        {% progress_bar label='' value=maintkit|getitem:0 max=maintkit|getitem:1 %}
                    {% else %}
                        <p><strong>Maintenance Kit: </strong> <em>unable to read</em></p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <h3>Top Staff</h3>
        <div class="row">
            <div class="col-sm-6">
                <h4>This Semester</h4>
                <table class="table table-striped table-hover">
                    <tr>
                        <th>User</th>
                        <th>Time</th>
                    </tr>

                    {% for staff in top_staff_semester %}
                        <tr>
                            <td>{{staff.user}}</td>
                            <td>{{staff.time}}</td>
                        </tr>
                    {% endfor %}
                </table>
                <p>(Since the semester started on {{current_semester_start}}.)</p>
            </div>
            <div class="col-sm-6">
                <h4>All-Time</h4>
                <table class="table table-striped table-hover">
                    <tr>
                        <th>User</th>
                        <th>Time</th>
                    </tr>

                    {% for staff in top_staff_alltime %}
                        <tr>
                            <td>{{staff.user}}</td>
                            <td>{{staff.time}}</td>
                        </tr>
                    {% endfor %}
                </table>
                <p>(Since records began on {{stats_epoch}}.)</p>
            </div>
        </div>


        <h3>Today's Lab Utilization</h3>
        <table class="table table-striped table-hover">
            <tr>
                <th>Desktop</th>
                <th>Idle (min)</th>
                <th>Busy (min)</th>
                <th>% Busy</th>
            </tr>
            {% for profile in desktop_profiles %}
                <tr>
                    <td>{{profile.hostname}}</td>
                    <td>{{profile.minutes_idle|floatformat:"0"}}</td>
                    <td>{{profile.minutes_busy|floatformat:"0"}}</td>
                    {% if profile.total_minutes <= 0 %}
                        <td>0%</td>
                    {% else %}
                        <td>{{profile.minutes_busy|div:profile.total_minutes|mul:100|floatformat:"0"}}%</td>
                    {% endif %}
                </tr>
            {% endfor %}
        </table>
    </div>
{% endblock %}
